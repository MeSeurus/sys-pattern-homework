# Домашнее задание по лекции "`12.8. Резервное копирование баз данных`" - `Попов Всеволод`

### Задание 1. Резервное копирование

Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Приведите ответ в свободной форме.

Ответ:

#### Вариант 1.1. Необходимость восстановить данные в полном объеме за предыдущий день

Решение: оптимальный вариант - использование полной ежедневной копии всей базы данных. Восстановление выполняется путем простой замены поврежденной базы на сохранённую версию предыдущего дня.

Преимущества:
Простота реализации и автоматизации процесса резервного копирования.
Минимальные затраты ресурсов системы.

Недостатки:
Потеря всех изменений, произошедших за последний день перед аварией.

#### Вариант 1.2. Необходимо восстановление данных за час до предполагаемой поломки

Решение: комбинация полных копий с инкрементными или дифференциальными копиями. Полная копия создается ежедневно (например ночью), а инкрементные обновления записываются ежечасно либо чаще, фиксируя изменения в базе данных за короткий промежуток времени. При восстановлении сначала используется полная дневная копия, а затем последовательно применяются инкрементные бэкапы, начиная с момента последней полной копии и заканчивая последним доступным обновлением.

Преимущества:
Значительное снижение риска потери данных благодаря частым инкрементам.
Возможность управления частотой создания инкрементов.

Недостатки:
Повышенные требования к хранилищу резервных копий и процессорам для обработки больших объемов данных.

#### Вариант 1.3. Возможность мгновенного переключения на исправленную базу данных
.
Решение: Наиболее эффективное решение - репликация данных и применение кластера баз данных (HA-кластеры). Один сервер (или группа серверов) работает активно, обеспечивая обработку запросов пользователей, второй сервер находится в режиме standby, постоянно синхронизируясь с активным узлом. При сбое активного узла система автоматически переключается на standby-сервер. В случае отказа основного сервера автоматическое переключение на рабочий node обеспечивает почти нулевое время простоя. Примером технологии репликации является PostgreSQL Hot Standby, MySQL Replication, Oracle Data Guard и др.

Преимущества:
Практически полное отсутствие простоя при отказе основной базы данных.
Высокая отказоустойчивость.

Недостатки:
Сложность настройки и поддержки инфраструктуры HA-кластера.
Увеличенная нагрузка на систему из-за постоянного мониторинга состояния узлов и передачи изменений.

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Приведите ответ в свободной форме.

Ответ:

#### 2.1. pgdump/pgrestore

pg_dump служит для создания резервной копии базы данных PostgreSQL.

Пример команды для создания полной резервной копии базы данных:

`pg_dump -U username -W -Fc database_name > /path/to/backup.dump`

-U username: Имя пользователя для подключения к базе данных.
-W: Запрашивает пароль при необходимости.
-Fc: Формат архивации для сжатия и дальнейшей эффективной загрузки.
database_name: Название базы данных, которую нужно сохранить.
/path/to/backup.dump: Файл, куда будет помещён дамп базы данных.

Что делает эта команда:
Создаёт полный архив указанной базы данных и сохраняет его в указанном файле.

***

Используя созданный ранее файл архива, можно восстановить базу данных командой pg_restore.

Пример команды для восстановления базы данных:

`pg_restore -U username -d new_database_name -v /path/to/backup.dump`

-U username: Пользователь для подключения к серверу.
-d new_database_name: Назначение восстановленной базы данных (если база не существует, она будет создана).
-v: Включает режим подробного вывода для отслеживания прогресса операции.
/path/to/backup.dump: Местоположение файла архива.

Что делает эта команда:
Восстанавливает всю структуру и содержимое базы данных из указанного архива.

#### 2.2 Автоматизация процесса резервного копирования 

Процесс резервного копирования автоматизируется с использованием инструментов планирования заданий операционной системы, таких как cron в Linux или Task Scheduler в Windows.
Например, для автоматической ежедневной резервной копии в Linux можно добавить следующее задание в crontab:

`0 2 * * * pg_dump -U postgres -Fc mydatabase > /backups/mydatabase_$(date +%Y-%m-%d).dump`

Это создаст ежедневную резервную копию базы данных mydatabase в папку /backups/. Дата добавления к имени файла позволит отслеживать версии архива.

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

Приведите ответ в свободной форме.

#### 3.1. Команды инкрементного резервного копирования MySQL

MySQL поддерживает два основных подхода к инкрементному резервированию:

Физический бэкап файлов данных. Например, XtraBackup от Percona Server.
Логический бэкап с применением бинарных журналов (binlog).

Наиболее распространённым инструментом для физического инкрементного резервного копирования является Percona XtraBackup, поддерживаемый официальным руководством MySQL.

Создание базовой (полной) резервной копии с помощью XtraBackup:

`innobackupex --user=root --password=your_password --no-timestamp /path/to/full_backup`
Где:
--user=root: Логин пользователя MySQL.
--password=your_password: Пароль пользователя.
--no-timestamp: Чтобы избежать случайного создания временных меток в пути к файлам.
/path/to/full_backup: Каталог, куда будут сохранены файлы резервной копии.

Эта команда создаёт полную физическую копию всех таблиц InnoDB и других типов таблиц, включая журналы транзакций.

Теперь создадим инкрементную копию относительно предыдущей полной резервной копии:

`innobackupex --incremental-basedir=/path/to/full_backup \`
             `--user=root --password=your_password \`
             `--no-timestamp /path/to/incremental_backup`
Здесь:
--incremental-basedir: Указываем путь к директории, содержащей предыдущую полную резервную копию.
/path/to/incremental_backup: Директория, где будет храниться инкрементная копия.

Эти шаги позволяют создавать инкрементные резервные копии, сохраняя только изменения с момента последнего полного резервного копирования.

#### 3.1.* Использование реплик vs. обычное резервное копирование

Репликация в MySQL представляет собой механизм дублирования данных одной базы данных на одну или несколько других баз данных. Она отличается от традиционного резервного копирования следующим:

Минимальная потеря данных: Репликация позволяет поддерживать актуальность вторичных серверов почти в реальном времени. Даже при падении первичного сервера, потерянные данные могут составлять лишь доли секунды.

Отказоустойчивость: Наличие реплицированных баз данных значительно повышает доступность системы. Если главный сервер выходит из строя, реплика мгновенно принимает нагрузку, сводя простои к минимуму.

Производительность: Вторичный сервер (реплика) может использоваться для чтения, снимая нагрузку с главного сервера. Это улучшает общую производительность системы.

Масштабируемость: Добавление новых реплик упрощает масштабирование приложения горизонтально, позволяя обслуживать больше пользователей одновременно.

Простота восстановления: Поскольку реплика всегда готова заменить мастер-сервер, восстановление производится быстро и прозрачно для пользователей.

Однако, несмотря на преимущества, репликация не заменяет традиционное резервное копирование. Для долгосрочного хранения и защиты от катастрофических повреждений базы данных, классических резервных копий всё равно необходим дополнительный слой защиты. Поэтому рекомендуемый подход — сочетание регулярного резервного копирования с технологией репликации - обеспечивает высокую доступность и минимальные риски потери данных.